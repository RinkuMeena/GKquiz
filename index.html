<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExamHub Premium</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <style>
        :root {
            --primary: #4F46E5; /* Indigo */
            --primary-dark: #4338ca;
            --success: #10B981; /* Emerald */
            --danger: #EF4444; /* Red */
            --background: #F3F4F6;
            --card-bg: #FFFFFF;
            --text-main: #1F2937;
            --text-light: #6B7280;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --glass: rgba(255, 255, 255, 0.9);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            margin: 0;
            color: var(--text-main);
            padding-bottom: 100px;
            -webkit-font-smoothing: antialiased;
        }

        /* --- HEADER (Glassmorphism) --- */
        header {
            background: var(--glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .brand {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(to right, #4F46E5, #9333EA);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .stats-container {
            display: flex;
            gap: 12px;
        }

        .stat-pill {
            padding: 6px 14px;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.2s;
        }
        
        .stat-pill:hover { transform: scale(1.05); }
        .s-blue { background: #DBEAFE; color: #1E40AF; }
        .s-green { background: #D1FAE5; color: #065F46; }
        .s-red { background: #FEE2E2; color: #991B1B; }

        /* --- QUIZ CONTAINER --- */
        #quiz-container {
            max-width: 720px;
            margin: 30px auto;
            padding: 0 15px;
        }

        /* --- CARD DESIGN --- */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0,0,0,0.03);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Badges */
        .badge-container { margin-bottom: 15px; display: flex; gap: 8px; }
        
        .badge {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 6px;
        }
        
        .badge-exam { background: #E0E7FF; color: #4338CA; }
        .badge-rev { background: #FFF7ED; color: #C2410C; border: 1px solid #FFEDD5; animation: pulse 2s infinite; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* Question Text */
        .q-text {
            font-family: 'Poppins', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-main);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        /* Options Grid */
        .opt-grid {
            display: grid;
            gap: 12px;
        }

        .opt-btn {
            background: #F9FAFB;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            padding: 16px 20px;
            text-align: left;
            font-size: 1rem;
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            position: relative;
        }

        .opt-btn:hover:not(:disabled) {
            background: #FFFFFF;
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.1);
        }

        /* Answer States */
        .opt-btn.correct {
            background: #ECFDF5 !important;
            border-color: var(--success) !important;
            color: var(--success) !important;
        }
        
        .opt-btn.correct::after {
            content: "‚úî"; position: absolute; right: 20px; font-weight: bold;
        }

        .opt-btn.wrong {
            background: #FEF2F2 !important;
            border-color: var(--danger) !important;
            color: var(--danger) !important;
            animation: shake 0.4s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Explanation Box */
        .exp-box {
            margin-top: 20px;
            padding: 16px;
            background: #FFFBEB;
            border-radius: 10px;
            border-left: 4px solid #F59E0B;
            color: #92400E;
            font-size: 0.95rem;
            line-height: 1.5;
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Floating Action Button (FAB) */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
            border-radius: 50%;
            color: white;
            border: none;
            box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.5);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            transition: transform 0.2s;
            z-index: 2000;
        }

        .fab:hover { transform: scale(1.1) rotate(5deg); }
        .fab:active { transform: scale(0.95); }

        /* Loader */
        #loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60vh;
            color: var(--text-light);
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #E5E7EB;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Mobile Responsive */
        @media (max-width: 640px) {
            header { flex-direction: column; gap: 10px; padding: 12px; }
            .stats-container { width: 100%; justify-content: space-between; }
            .stat-pill { flex: 1; justify-content: center; padding: 8px; }
            .card { padding: 20px; border-radius: 12px; }
            .q-text { font-size: 1.1rem; }
        }

    </style>
</head>
<body>

<header>
    <div class="brand">ExamHub <span style="font-size:0.9rem; font-weight:500; color:#10B981; background:#D1FAE5; padding:2px 8px; border-radius:12px; vertical-align:middle;">PRO</span></div>
    <div class="stats-container">
        <div class="stat-pill s-blue">
            <span>üìù</span> <span id="s-attempted">0</span>
        </div>
        <div class="stat-pill s-green">
            <span>‚ú®</span> <span id="s-correct">0</span>
        </div>
        <div class="stat-pill s-red">
            <span>üî•</span> <span id="s-wrong">0</span>
        </div>
    </div>
</header>

<div id="loader">
    <div class="spinner"></div>
    <span>Syncing with Server...</span>
</div>

<div id="quiz-container"></div>

<button class="fab" onclick="toggleLang()" title="Switch Language (A/‡§Ö)">
    A/‡§Ö
</button>

<script>
    // ‚úÖ Your Live Google Sheet Link
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRCPCEpMa6Nj55kQ87O2XRHE0pgL3C1dds7SVxqxk-5Iuh7wJIH00p0Q3LkrD8b9gX_GpM_sHlRenRY/pub?output=csv";

    let allQuestions = [];
    let currentLang = 'en';
    let answeredState = {}; // Keeps track of answers
    let stats = { attempted: 0, correct: 0, wrong: 0 };

    // --- INITIALIZE ---
    function init() {
        Papa.parse(SHEET_URL, {
            download: true,
            header: true,
            skipEmptyLines: true,
            transformHeader: h => h.toLowerCase().trim(),
            complete: function(results) {
                if (results.data.length > 0) {
                    // Filter & Add Unique ID
                    allQuestions = results.data
                        .filter(q => q.q_en)
                        .map((q, i) => ({ ...q, uniqueId: `q_${i}_${Date.now()}` }));
                    
                    // Initial Shuffle
                    allQuestions.sort(() => Math.random() - 0.5);
                    
                    document.getElementById('loader').style.display = 'none';
                    renderAll();
                } else {
                    document.getElementById('loader').innerHTML = "‚ö†Ô∏è Sheet Empty!";
                }
            },
            error: () => document.getElementById('loader').innerHTML = "‚ö†Ô∏è Connection Failed!"
        });
    }

    // --- RENDER ENGINE ---
    function renderAll() {
        const container = document.getElementById('quiz-container');
        container.innerHTML = '';

        allQuestions.forEach((q, index) => {
            container.appendChild(createCard(q, index));
        });
    }

    function createCard(q, index) {
        let card = document.createElement('div');
        card.className = 'card';
        
        // Determine Language
        const isHindi = currentLang === 'hi';
        const qText = (isHindi && q.q_hi) ? q.q_hi : q.q_en;
        const expText = (isHindi && q.exp_hi) ? q.exp_hi : q.exp_en;
        const expLabel = isHindi ? '‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ' : 'Explanation';

        // Options Fallback
        const opts = [
            (isHindi && q.opt_a_hi) ? q.opt_a_hi : q.opt_a,
            (isHindi && q.opt_b_hi) ? q.opt_b_hi : q.opt_b,
            (isHindi && q.opt_c_hi) ? q.opt_c_hi : q.opt_c,
            (isHindi && q.opt_d_hi) ? q.opt_d_hi : q.opt_d
        ];

        // Core Data
        let correctIdx = 0;
        const ansKey = q.correct ? q.correct.toLowerCase().trim() : 'a';
        if(ansKey === 'b') correctIdx = 1;
        if(ansKey === 'c') correctIdx = 2;
        if(ansKey === 'd') correctIdx = 3;

        // HTML Structure
        let badges = `<span class="badge badge-exam">${q.exam || 'GK'}</span>`;
        if(q.isRevision) badges += `<span class="badge badge-rev">REVISION #${q.revCount}</span>`;

        card.innerHTML = `
            <div class="badge-container">${badges}</div>
            <div class="q-text">Q${index+1}. ${qText}</div>
            <div class="opt-grid"></div>
            <div class="exp-box">
                <strong>${expLabel}:</strong> ${expText || 'No details available.'}
            </div>
        `;

        // Render Buttons
        const optGrid = card.querySelector('.opt-grid');
        opts.forEach((optText, i) => {
            if(!optText) return;
            
            let btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = optText;

            // Check Memory State
            if(answeredState[q.uniqueId]) {
                const mem = answeredState[q.uniqueId];
                btn.disabled = true;
                
                // Apply Colors from Memory
                if(i === mem.correctIdx) btn.classList.add('correct');
                if(i === mem.clickedIdx && !mem.isCorrect) btn.classList.add('wrong');
                
                // Show Explanation if answered
                card.querySelector('.exp-box').style.display = 'block';
            } else {
                // Active Listener
                btn.onclick = () => handleAnswer(q, index, i, correctIdx, card, btn);
            }
            
            optGrid.appendChild(btn);
        });

        return card;
    }

    // --- LOGIC HANDLER ---
    function handleAnswer(qData, index, clickedIdx, correctIdx, card, btn) {
        if(answeredState[qData.uniqueId]) return;

        const isCorrect = (clickedIdx === correctIdx);
        
        // 1. Save State
        answeredState[qData.uniqueId] = { clickedIdx, correctIdx, isCorrect };

        // 2. Update UI (Disable all btns)
        const allBtns = card.querySelectorAll('.opt-btn');
        allBtns.forEach((b, i) => {
            b.disabled = true;
            if(i === correctIdx) b.classList.add('correct'); // Always show correct
        });

        if(!isCorrect) {
            btn.classList.add('wrong');
            stats.wrong++;
            
            // --- SPACED REPETITION LOGIC ---
            // Insert copy at: Current Index + 8 (Short term memory)
            const revCount = (qData.revCount || 0) + 1;
            if(revCount <= 3) { // Max 3 repeats
                let retryQ = { ...qData, uniqueId: qData.uniqueId + `_r${revCount}`, isRevision: true, revCount: revCount };
                
                // Add to array
                let targetPos = index + 8;
                if(targetPos >= allQuestions.length) allQuestions.push(retryQ);
                else allQuestions.splice(targetPos, 0, retryQ);
                
                // Re-render list to show new position (Keeping scroll)
                setTimeout(() => refreshViewKeepScroll(), 500);
            }

        } else {
            stats.correct++;
        }

        stats.attempted++;
        updateStats();
        card.querySelector('.exp-box').style.display = 'block';
    }

    function updateStats() {
        document.getElementById('s-attempted').innerText = stats.attempted;
        document.getElementById('s-correct').innerText = stats.correct;
        document.getElementById('s-wrong').innerText = stats.wrong;
    }

    function refreshViewKeepScroll() {
        const scrollPos = window.scrollY;
        renderAll();
        window.scrollTo(0, scrollPos);
    }

    function toggleLang() {
        currentLang = currentLang === 'en' ? 'hi' : 'en';
        refreshViewKeepScroll();
    }

    init();
</script>
</body>
</html>
