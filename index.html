<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sarkari Exam Live Quiz</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #2980b9; --bg: #f4f7f6; --card: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }

        /* HEADER */
        header { background: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .logo { font-weight: 800; font-size: 1.2rem; color: var(--primary); }
        .stats { font-weight: bold; font-size: 0.9rem; display: flex; gap: 15px; }
        .stat-box { background: #f8f9fa; padding: 5px 10px; border-radius: 20px; border: 1px solid #eee; }
        .green { color: #27ae60; } .red { color: #c0392b; }

        /* QUIZ AREA */
        #quiz-container { max-width: 700px; margin: 20px auto; padding: 15px; }
        
        .card { background: var(--card); padding: 20px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); animation: slideUp 0.4s ease; border-left: 5px solid transparent; }
        .card:hover { transform: translateY(-2px); transition: 0.3s; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .exam-tag { background: #e3f2fd; color: #1565c0; padding: 5px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 800; display: inline-block; letter-spacing: 0.5px; }
        .q-text { font-size: 1.15rem; margin: 15px 0; font-weight: 600; color: #34495e; line-height: 1.5; }

        .opt-btn { width: 100%; padding: 14px; margin-bottom: 10px; border: 2px solid #f1f2f6; background: #fff; text-align: left; cursor: pointer; border-radius: 8px; font-size: 1rem; color: #555; transition: all 0.2s; }
        .opt-btn:hover:not([disabled]) { background: #f8f9fa; border-color: #dcdde1; }
        
        .correct { background: #d4edda !important; border-color: #27ae60 !important; color: #155724 !important; font-weight: 600; }
        .wrong { background: #f8d7da !important; border-color: #c0392b !important; color: #721c24 !important; }

        .exp-box { display: none; margin-top: 15px; background: #fff3cd; padding: 15px; border-radius: 8px; font-size: 0.95rem; color: #856404; border-left: 4px solid #ffeeba; }

        /* LOADING & ERROR */
        #loader { text-align: center; margin-top: 100px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* FLOATING BTN */
        .fab { position: fixed; bottom: 25px; right: 25px; background: var(--primary); color: white; width: 55px; height: 55px; border-radius: 50%; border: none; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(44, 62, 80, 0.4); font-size: 1rem; transition: transform 0.2s; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .fab:active { transform: scale(0.95); }

    </style>
</head>
<body>

<header>
    <div class="logo">ExamHub <span style="font-size:0.8rem; color:green; font-weight:normal">● Live</span></div>
    <div class="stats">
        <div class="stat-box">Total: <span id="s-total">0</span></div>
        <div class="stat-box green">✔ <span id="s-correct">0</span></div>
        <div class="stat-box red">✘ <span id="s-wrong">0</span></div>
    </div>
</header>

<div id="loader">
    <div class="spinner"></div>
    <div id="status-text">Connecting to Google Sheet...</div>
</div>

<div id="quiz-container"></div>

<button class="fab" onclick="toggleLang()" title="Switch Language">A/अ</button>

<script>
    // ==========================================
    // ✅ YOUR FIXED LINK (CSV MODE)
    // ==========================================
    // मैंने आपके लिंक से 'pubhtml' हटाकर 'pub?output=csv' कर दिया है
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRCPCEpMa6Nj55kQ87O2XRHE0pgL3C1dds7SVxqxk-5Iuh7wJIH00p0Q3LkrD8b9gX_GpM_sHlRenRY/pub?output=csv";
    
    // ==========================================

    let allQuestions = [];
    let currentLang = 'en';
    let stats = { total: 0, correct: 0, wrong: 0 };

    function fetchQuestions() {
        Papa.parse(SHEET_URL, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                // डेटा चेक करें
                if (results.data && results.data.length > 0) {
                    // सिर्फ वो प्रश्न लें जिनमें 'exam' और 'q_en' भरा हुआ हो
                    allQuestions = results.data.filter(row => row.exam && row.q_en);
                    
                    if(allQuestions.length === 0) {
                        showError("Sheet खाली है या Headers गलत हैं।");
                        return;
                    }

                    // Shuffle Questions
                    allQuestions.sort(() => Math.random() - 0.5);
                    
                    document.getElementById('loader').style.display = 'none';
                    renderQuestions();
                } else {
                    showError("No data found in Sheet.");
                }
            },
            error: function(err) {
                showError("Connection Failed! Internet check karein.");
                console.error(err);
            }
        });
    }

    function renderQuestions() {
        const container = document.getElementById('quiz-container');
        // एक बार में 100 प्रश्न लोड करें (बाद में और लोड कर सकते हैं)
        const batch = allQuestions.slice(0, 100); 
        
        batch.forEach((q, index) => {
            let card = document.createElement('div');
            card.className = 'card';
            card.dataset.idx = index;

            // Correct Answer Calculation (A/B/C/D -> 0/1/2/3)
            let correctIndex = 0;
            const ansChar = q.correct ? q.correct.toString().trim().toLowerCase() : 'a';
            if(ansChar === 'b') correctIndex = 1;
            else if(ansChar === 'c') correctIndex = 2;
            else if(ansChar === 'd') correctIndex = 3;

            card.innerHTML = `
                <div class="exam-tag">${q.exam || 'GK'}</div>
                <div class="q-text" id="q-${index}"></div>
                <div class="opt-box" id="opt-${index}"></div>
                <div class="exp-box" id="exp-${index}"></div>
            `;
            container.appendChild(card);
            
            // Render Content
            updateCardLang(card, q, index, correctIndex);
        });
    }

    function updateCardLang(card, q, index, correctIndex) {
        const qText = currentLang === 'en' ? q.q_en : q.q_hi;
        card.querySelector(`#q-${index}`).innerText = `Q${index+1}. ${qText}`;
        
        const optBox = card.querySelector(`#opt-${index}`);
        const expBox = card.querySelector(`#exp-${index}`);
        
        // ऑप्शन्स तभी बदलें जब तक उत्तर न दिया हो
        if(!card.classList.contains('answered')) {
            optBox.innerHTML = '';
            const opts = [q.opt_a, q.opt_b, q.opt_c, q.opt_d];
            
            opts.forEach((opt, i) => {
                // अगर ऑप्शन खाली है तो न दिखाएं
                if(!opt) return;

                let btn = document.createElement('button');
                btn.className = 'opt-btn';
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(card, btn, i, correctIndex);
                optBox.appendChild(btn);
            });
        }

        // व्याख्या हमेशा अपडेट करें (ताकि भाषा बदलने पर दिखे)
        const expText = currentLang === 'en' ? q.exp_en : q.exp_hi;
        const lbl = currentLang === 'en' ? "Explanation:" : "व्याख्या:";
        expBox.innerHTML = `<strong>${lbl}</strong> ${expText || 'No explanation available.'}`;
    }

    function checkAnswer(card, btn, clickedIdx, correctIdx) {
        if(card.classList.contains('answered')) return;
        card.classList.add('answered');

        const allBtns = card.querySelectorAll('.opt-btn');
        allBtns.forEach(b => b.disabled = true);

        stats.total++;
        
        // Border Color Logic
        if(clickedIdx === correctIdx) {
            btn.classList.add('correct');
            stats.correct++;
            card.style.borderLeftColor = "#27ae60"; // Green Border
        } else {
            btn.classList.add('wrong');
            stats.wrong++;
            card.style.borderLeftColor = "#c0392b"; // Red Border
            
            // Show correct answer
            if(allBtns[correctIdx]) allBtns[correctIdx].classList.add('correct');
        }

        // Update Stats UI
        document.getElementById('s-total').innerText = stats.total;
        document.getElementById('s-correct').innerText = stats.correct;
        document.getElementById('s-wrong').innerText = stats.wrong;
        
        // Show Explanation
        card.querySelector('.exp-box').style.display = 'block';
    }

    function toggleLang() {
        currentLang = currentLang === 'en' ? 'hi' : 'en';
        document.getElementById('quiz-container').innerHTML = '';
        renderQuestions();
    }

    function showError(msg) {
        const loader = document.getElementById('loader');
        loader.innerHTML = `<div style="color:red; font-size:1.2rem;">⚠️ ${msg}</div><br><button onclick="location.reload()" style="padding:10px;">Retry</button>`;
    }

    // Start
    fetchQuestions();

</script>
</body>
</html>
